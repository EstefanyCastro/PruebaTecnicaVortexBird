<div class="purchase-container">
  <div class="container py-5">
    <!-- Loading State -->
    <div *ngIf="loading && !movie" class="text-center py-5">
      <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <p class="mt-3 text-muted">Cargando información...</p>
    </div>

    <!-- Main Content -->
    <div *ngIf="!loading && movie" class="row">
      <!-- Progress Steps -->
      <div class="col-12 mb-4">
        <div class="steps-container">
          <div class="step" [class.active]="currentStep >= 1" [class.completed]="currentStep > 1">
            <div class="step-circle">
              <i class="bi" [class.bi-check-lg]="currentStep > 1" [class.bi-ticket-detailed]="currentStep <= 1"></i>
            </div>
            <span class="step-label">Cantidad</span>
          </div>
          <div class="step-line" [class.active]="currentStep > 1"></div>
          <div class="step" [class.active]="currentStep >= 2" [class.completed]="currentStep > 2">
            <div class="step-circle">
              <i class="bi" [class.bi-check-lg]="currentStep > 2" [class.bi-credit-card]="currentStep <= 2"></i>
            </div>
            <span class="step-label">Pago</span>
          </div>
          <div class="step-line" [class.active]="currentStep > 2"></div>
          <div class="step" [class.active]="currentStep >= 3">
            <div class="step-circle">
              <i class="bi bi-check-circle"></i>
            </div>
            <span class="step-label">Confirmación</span>
          </div>
        </div>
      </div>

      <!-- Movie Information Card -->
      <div class="col-lg-4 mb-4">
        <div class="card movie-summary-card shadow-sm sticky-top">
          <img [src]="movie.imageUrl" [alt]="movie.title" class="card-img-top" onerror="this.src='assets/noImage.jpg'">
          <div class="card-body">
            <h5 class="card-title fw-bold">{{ movie.title }}</h5>
            <p class="text-muted mb-2">
              <i class="bi bi-tag-fill me-1"></i>{{ movie.genre }}
            </p>
            <p class="text-muted mb-3">
              <i class="bi bi-clock me-1"></i>{{ movie.duration }} minutos
            </p>
            <hr>
            <div class="price-summary">
              <div class="d-flex justify-content-between mb-2">
                <span>Precio por entrada:</span>
                <span class="fw-bold">${{ movie.price | number:'1.0-0' }}</span>
              </div>
              <div class="d-flex justify-content-between mb-2">
                <span>Cantidad:</span>
                <span class="fw-bold">{{ quantity }}</span>
              </div>
              <hr>
              <div class="d-flex justify-content-between">
                <span class="fs-5 fw-bold">Total:</span>
                <span class="fs-4 fw-bold text-primary">${{ getTotalPrice() | number:'1.0-0' }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Purchase Form -->
      <div class="col-lg-8">
        <div class="card purchase-form-card shadow-sm">
          <div class="card-body p-4">
            <form [formGroup]="purchaseForm">
              <!-- Step 1: Quantity Selection -->
              <div *ngIf="currentStep === 1" class="step-content">
                <h3 class="mb-4">
                  <i class="bi bi-ticket-detailed me-2"></i>
                  Selecciona la cantidad de entradas
                </h3>
                
                <div class="quantity-selector">
                  <label class="form-label fw-bold">Cantidad de entradas (máx. 10)</label>
                  <div class="input-group input-group-lg">
                    <button 
                      class="btn btn-outline-primary" 
                      type="button"
                      (click)="quantity > 1 && purchaseForm.patchValue({quantity: quantity - 1})">
                      <i class="bi bi-dash-lg"></i>
                    </button>
                    <input 
                      type="number" 
                      class="form-control text-center"
                      formControlName="quantity"
                      min="1"
                      max="10"
                      [class.is-invalid]="purchaseForm.get('quantity')?.touched && purchaseForm.get('quantity')?.invalid">
                    <button 
                      class="btn btn-outline-primary" 
                      type="button"
                      (click)="quantity < 10 && purchaseForm.patchValue({quantity: quantity + 1})">
                      <i class="bi bi-plus-lg"></i>
                    </button>
                  </div>
                  <small class="text-danger" *ngIf="purchaseForm.get('quantity')?.touched && purchaseForm.get('quantity')?.invalid">
                    {{ getErrorMessage('quantity') }}
                  </small>
                </div>

                <div class="alert alert-info mt-4">
                  <i class="bi bi-info-circle me-2"></i>
                  <strong>Nota:</strong> El precio total se calculará automáticamente según la cantidad de entradas seleccionadas.
                </div>

                <div class="d-flex justify-content-between mt-4">
                  <button type="button" class="btn btn-outline-secondary" (click)="goBack()">
                    <i class="bi bi-arrow-left me-2"></i>Volver
                  </button>
                  <button type="button" class="btn btn-primary btn-lg" (click)="goToStep(2)" [disabled]="purchaseForm.get('quantity')?.invalid">
                    Continuar<i class="bi bi-arrow-right ms-2"></i>
                  </button>
                </div>
              </div>

              <!-- Step 2: Payment Information -->
              <div *ngIf="currentStep === 2" class="step-content">
                <h3 class="mb-4">
                  <i class="bi bi-credit-card me-2"></i>
                  Información de pago
                </h3>

                <!-- Error Message -->
                <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert">
                  <i class="bi bi-exclamation-triangle-fill me-2"></i>
                  {{ errorMessage }}
                  <button type="button" class="btn-close" (click)="errorMessage = ''"></button>
                </div>

                <!-- Card Number -->
                <div class="mb-3">
                  <label class="form-label fw-bold">Número de tarjeta</label>
                  <div class="input-group">
                    <span class="input-group-text">
                      <i class="bi bi-credit-card-2-front"></i>
                    </span>
                    <input 
                      type="text" 
                      class="form-control" 
                      formControlName="cardNumber"
                      placeholder="1234567812345678"
                      maxlength="16"
                      (input)="formatCardNumber($event)"
                      [class.is-invalid]="purchaseForm.get('cardNumber')?.touched && purchaseForm.get('cardNumber')?.invalid">
                  </div>
                  <small class="text-danger" *ngIf="purchaseForm.get('cardNumber')?.touched && purchaseForm.get('cardNumber')?.invalid">
                    {{ getErrorMessage('cardNumber') }}
                  </small>
                </div>

                <!-- Card Holder -->
                <div class="mb-3">
                  <label class="form-label fw-bold">Nombre del titular</label>
                  <div class="input-group">
                    <span class="input-group-text">
                      <i class="bi bi-person"></i>
                    </span>
                    <input 
                      type="text" 
                      class="form-control" 
                      formControlName="cardHolder"
                      placeholder="JUAN PÉREZ"
                      style="text-transform: uppercase;"
                      [class.is-invalid]="purchaseForm.get('cardHolder')?.touched && purchaseForm.get('cardHolder')?.invalid">
                  </div>
                  <small class="text-danger" *ngIf="purchaseForm.get('cardHolder')?.touched && purchaseForm.get('cardHolder')?.invalid">
                    {{ getErrorMessage('cardHolder') }}
                  </small>
                </div>

                <!-- Expiry and CVV -->
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Fecha de vencimiento</label>
                    <div class="row g-2">
                      <div class="col-6">
                        <input 
                          type="text" 
                          class="form-control" 
                          formControlName="expiryMonth"
                          placeholder="MM"
                          maxlength="2"
                          [class.is-invalid]="purchaseForm.get('expiryMonth')?.touched && purchaseForm.get('expiryMonth')?.invalid">
                        <small class="text-danger" *ngIf="purchaseForm.get('expiryMonth')?.touched && purchaseForm.get('expiryMonth')?.invalid">
                          {{ getErrorMessage('expiryMonth') }}
                        </small>
                      </div>
                      <div class="col-6">
                        <input 
                          type="text" 
                          class="form-control" 
                          formControlName="expiryYear"
                          placeholder="AA"
                          maxlength="2"
                          [class.is-invalid]="purchaseForm.get('expiryYear')?.touched && purchaseForm.get('expiryYear')?.invalid">
                        <small class="text-danger" *ngIf="purchaseForm.get('expiryYear')?.touched && purchaseForm.get('expiryYear')?.invalid">
                          {{ getErrorMessage('expiryYear') }}
                        </small>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">CVV</label>
                    <input 
                      type="text" 
                      class="form-control" 
                      formControlName="cvv"
                      placeholder="123"
                      maxlength="4"
                      [class.is-invalid]="purchaseForm.get('cvv')?.touched && purchaseForm.get('cvv')?.invalid">
                    <small class="text-danger" *ngIf="purchaseForm.get('cvv')?.touched && purchaseForm.get('cvv')?.invalid">
                      {{ getErrorMessage('cvv') }}
                    </small>
                  </div>
                </div>

                <div class="alert alert-warning mt-3">
                  <i class="bi bi-shield-lock me-2"></i>
                  <strong>Seguridad:</strong> Tu información de pago está protegida y cifrada.
                </div>

                <div class="d-flex justify-content-between mt-4">
                  <button type="button" class="btn btn-outline-secondary" (click)="goToStep(1)">
                    <i class="bi bi-arrow-left me-2"></i>Volver
                  </button>
                  <button type="button" class="btn btn-success btn-lg" (click)="onSubmit()" [disabled]="loading || purchaseForm.invalid">
                    <span *ngIf="!loading">
                      <i class="bi bi-check-circle me-2"></i>Confirmar compra
                    </span>
                    <span *ngIf="loading">
                      <span class="spinner-border spinner-border-sm me-2"></span>
                      Procesando...
                    </span>
                  </button>
                </div>
              </div>

              <!-- Step 3: Confirmation -->
              <div *ngIf="currentStep === 3" class="step-content text-center">
                <div class="confirmation-icon mb-4">
                  <i class="bi bi-check-circle-fill text-success"></i>
                </div>
                <h2 class="mb-3">¡Compra realizada con éxito!</h2>
                <p class="lead text-muted mb-4">
                  Tu compra ha sido procesada correctamente. Recibirás un correo de confirmación con los detalles de tu compra.
                </p>

                <div class="card confirmation-details mb-4">
                  <div class="card-body">
                    <h5 class="card-title mb-3">Detalles de la compra</h5>
                    <div class="row text-start">
                      <div class="col-6 mb-2">
                        <strong>Película:</strong>
                      </div>
                      <div class="col-6 mb-2">
                        {{ completedPurchase?.movieTitle || movie?.title }}
                      </div>
                      <div class="col-6 mb-2">
                        <strong>Cantidad:</strong>
                      </div>
                      <div class="col-6 mb-2">
                        {{ completedPurchase?.quantity || quantity }} entrada(s)
                      </div>
                      <div class="col-6 mb-2">
                        <strong>Precio unitario:</strong>
                      </div>
                      <div class="col-6 mb-2">
                        ${{ completedPurchase?.unitPrice | number:'1.0-0' }}
                      </div>
                      <div class="col-6 mb-2">
                        <strong>Total pagado:</strong>
                      </div>
                      <div class="col-6 mb-2">
                        <span class="text-primary fw-bold">${{ completedPurchase?.totalAmount | number:'1.0-0' }}</span>
                      </div>
                      <div class="col-6 mb-2">
                        <strong>Estado:</strong>
                      </div>
                      <div class="col-6 mb-2">
                        <span class="badge bg-success">{{ completedPurchase?.status }}</span>
                      </div>
                      <div class="col-6 mb-2">
                        <strong>Fecha:</strong>
                      </div>
                      <div class="col-6 mb-2">
                        {{ completedPurchase?.purchaseDate | date:'dd/MM/yyyy HH:mm' }}
                      </div>
                      <div class="col-6">
                        <strong>Código de confirmación:</strong>
                      </div>
                      <div class="col-6">
                        <span class="badge bg-primary">{{ completedPurchase?.confirmationCode }}</span>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="alert alert-info">
                  <i class="bi bi-envelope me-2"></i>
                  Hemos enviado un correo electrónico con la confirmación y los detalles de tu compra.
                </div>

                <div class="d-flex gap-3 justify-content-center mt-4">
                  <button type="button" class="btn btn-primary btn-lg" (click)="goToHome()">
                    <i class="bi bi-house me-2"></i>Volver al inicio
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Error State -->
    <div *ngIf="!loading && !movie && errorMessage" class="text-center py-5">
      <i class="bi bi-exclamation-triangle text-warning" style="font-size: 4rem;"></i>
      <h3 class="mt-3">{{ errorMessage }}</h3>
      <button class="btn btn-primary mt-3" (click)="goToHome()">
        <i class="bi bi-arrow-left me-2"></i>Volver al inicio
      </button>
    </div>
  </div>
</div>
